# 2.NoSQL

# 一 概述
## 1 简介

NoSQL(Not Only SQL,意即“不仅仅是SQL”)，泛指非关系型的数据库。随着互联网web2.0网站的兴起，传统的关系数据库在应付web2.0网站，特别是超大规模和高并发的SNS(Social Network Sofware，社会性网络软件)类型的web2.0纯动态网站已经显得力不从心

c语言开发

主要的应用场景：
- 缓存
- 消息队列
- 网站统计、应用排行榜
- 数据过期处理


为什么需要NoSQL：用以解决传统关系型数据库难以解决的几个问题
1. high performance：高并发读写
2. huge storage：海量数据的高效存储和访问
3. high scalability && high availability:高扩展性和高可用性


### 1.1 优点：
1. 易扩展
2. 灵活的数据结构
3. 大数据量，高性能
4. 高可用

### 1.2 缺点
1. 复杂查询性能不高
2. 一般都不能实现事务的强一致性
3. 内存开销

## 3 常识
### 3.1 NoSQL数据库的四大分类
- 键值(Key-Value)存储数据库(优势：快速查询，劣势 ：缺少结构化):主要会使用到一个哈希表，这个表中有一个特定的键和一个指针指向特定的数据。Key/value模型对于IT系统来说的优势在于简单、易部署。但是如果DBA只对部分值进行查询或更新的时候，Key/value就显得效率低下了。举例如Redis.
- 列存储数据库（功能局限）:通常是用来应对分布式存储的海量数据。键仍然存在，但是它们的特点是指向了多个列。
- 文档型数据库:同第一种键值存储相类似。该类型的数据模型是版本化的文档，半结构化的文档以特定的格式存储，比如JSON。文档型数据库可 以看作是键值数据库的升级版，允许之间嵌套键值。而且文档型数据库比键值数据库的查询效率更高。如：CouchDB, MongoDb. 
- 图形(Graph)数据库:图形结构的数据库同其他行列以及刚性结构的SQL数据库不同，它是使用灵活的图形模型，并且能够扩展到多个服务器上。

### 3.2 NoSQL的主要产品
- couchdb
- redis
- neo4j
- mongodb
- membase
- riak


# 三 基础
## 0 架构
### CAP定理
CAP定理可以说是NoSQL和分布式的基石。CAP三者是鱼和熊掌不可兼得，是一个三角形的关系，提高其中两个就会降低第三个。(参考链接 todo)
 
C(Consistency)：和事务的C不同，事务的C表示内部的一致性，而这里的C表示分布式的一致性

A(Availability)

P(Partition Tolerance)：分区容错性。

### BASE理论
由CAP定理演变而来，它是分布式系统需要满足的最低条件：

1. Basically Available:基本可用。指分布式系统在出现不可预知故障的时候，允许损失部分可用性，可能会出现以下两种情况
    1. 响应时间上的损失
    2. 功能上的损失
2. Soft State：软状态，也称弱状态。是指允许系统存在中间状态，但不会影响到系统的可用性。即允许系统在不同节点的数据副本之间进行数据同步时存在延时。
    1. 比如更新完某个分区的数据后立刻查询另外一个分区的数据
3. Eventually Consistent:最终一致性。要求数据副本最终能够一致，而不是实时一致。最终一致性分为五种
    1. 因果一致性
    2. 读己之所写
    3. 会话一致性
    4. 单调读一致性
    5. 单调写一致性

### 底层存储技术-LSM树
Log-Structured Merge-Tree:日志结构合并树/日志结构归并树。
1. 思想：日志化的思想
1. 特点
    1. 增量式写入：数据都是追加的。写的时候之前的数据是静态的，不会受影响
    2. 线性返回，线性查找：因为数据是有序的，所以可以做二分查找

和B/B+ Tree的对比:
1. 查询时：虽然B树可以通过降低树的高低来提高效率，但是还是会发生随机IO；而LSM树是顺序IO，效率更高
1. 更新时：B Tree是做了一次查询加一次更新操作，而LSM树只需要查询加打上更新标记，然后定期合并
1. 删除时：B Tree是做了一次查询加一次删除操作，而LSM树只需要查询加打上删除标记，然后定期合并