# 6.MySQL
[TOC]

# 一 概述
## 1 简介
1. mysql是开源的关系型数据库管理系统，最早由MySQL AB公司开发，目前属于oracle公司
1. MySQL数据库命令不区分大小写。但在MAC的终端，如果你想使用tab自动补全命令，那么你就必须使用大写

## 2 历史
在mysql8.0以下版本中，你如果什么都不修改，默认的CHARSET是Latin1，默认的COLLATE是latin1_swedish_ci

### 2.8 MySQL8
从mysql 8.0开始，mysql默认的`CHARSET`已经不再是Latin1了，改为了utf8mb4，并且默认的COLLATE也改为了`utf8mb4_0900_ai_ci`，`utf8mb4_0900_ai_ci`大体上就是unicode的进一步细分，0900指代unicode比较算法的编号（ Unicode Collation Algorithm version），ai表示accent insensitive（发音无关），例如e, è, é, ê 和 ë是一视同仁的。

## 3 常识
### 3.1 mysql用什么语言写的
mysql是c语言写的，红帽系统中默认有mysql

## 4 文档网址等
1. Official Reference Manual
    1. https://dev.mysql.com/doc/refman/8.0/en/
        1. 常用目录`SQL Statements`

# 二 安装配置
## 1 mac
### dmg安装
在mac下dmg安装后会有两个mysql的目录：/usr/local/mysql, 这是一个link，指向/usr/local/mysql-xxxxx...(即实际的mysql目录)

### brew安装

### 从低版本升级上来
运行脚本`mysql_upgrade -u root -p`

### 配置
mysql的配置文件路径查找优先级为`/etc/my.cnf`,`/etc/mysql/my.cnf`,`/usr/local/etc/my.cnf`，通过Homebrew安装的my.cnf放在`/usr/local/etc/`中。

```bash
```

mysql数据文件存放目录`/usr/local/var/mysql`，不同系统可能不一样，可通过`show variables like "%datadir%";`查看

## 2 win
1. msi是安装版，zip是免安装版，后者比前者大而且配置好可能要花一番功夫

## 3 linux

# 三 基础

## 1 角色
使用：
1. 修改角色密码
    1. mysql8+修改密码
        
        ```sql
        ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'password';
        ```

## 2 数据库
使用：
1. 创建数据库`CREATE DATABASE/SCHEMA IF NOT EXISTS dbNameA DEFAULT CHARSET utf8 COLLATE utf8_general_ci;`
    1. 根据官方文档`CREATE DATABASE`和`CREATE SCHEMA`是一样的(这和MSSQL区别很大)
    2. The `CHARACTER SET`(`CHARACTER`)option specifies the default database character set.用于指定数据库默认的字符集(通过`SHOW CHARACTER SET`查看支持的字符集)
        1. mysql中有utf8和utf8mb4两种编码，在mysql中请大家忘记utf8，永远使用utf8mb4。这是mysql的一个遗留问题，mysql中的utf8最多只能支持3bytes长度的字符编码，对于一些需要占据4bytes的文字，mysql的utf8就不支持了，要使用utf8mb4才行。
    3. The `COLLATE option` specifies the default database collation.用于指定字符类型(如`VARCHAR`，`CHAR`，`TEXT`等)的排序规则，凡是涉及到字符类型比较的或排列的地方，都和`COLLATE`有关。`COLLATE`通常是和数据编码（`CHARSET`）相关的，一般来说每种CHARSET都有多种它所支持的COLLATE，并且每种CHARSET都指定一种COLLATE为默认值(可通过`show collation;`查看)。
        1. 后缀带有`_ci`是Case Insensitive的缩写，即大小写无关，也就是说”A”和”a”在排序和比较的时候是一视同仁的。`selection * from table1 where field1=”a”;`同样可以把field1为”A”的值选出来。同理`_cs`后缀的COLLATE，则是Case Sensitive，即大小写敏感的
        2. 以常用的`utf8mb4`为例，最常用的COLLATE有：
            1. `utf8mb4_general_ci`(默认)和`utf8mb4_unicode_ci`：对于中文和英文来说，没有任何区别。但是对其他语言就不一定了，不过差别也非常小，一般情况下随便用哪个都行，非要比较的话 ，因为`utf8mb4_general_ci`老一点的标准，更推荐使用`utf8mb4_unicode_ci`。
            3. `utf8mb4_bin`:将所有字符看作二进制串，然后从最高位往最低位比对。所以很显然它是区分大小写的
            4. `utf8mb4_0900_bin`
        3. `COLLATE`级别:从上到下，优先级递增
            1. 实例级别：实例级别的COLLATE设置就是mysql配置文件或启动指令中的collation_connection系统变量
            2. 库级别：建库的时候，设置的是库级别的`COLLATE`，如果没有指定，则使用默认值；
            3. 表级别：建表的时候设置的是表级别的`COLLATE`，如果没有指定，则会继承库级别的设置
            4. 列级别：列级别的设置，则在CREATE TABLE中声明列的时候指定，同理未指定时继承表级别的
            5. SQL级别：可以在写SQL查询的时候显示声明COLLATE来覆盖任何库表列的COLLATE设置，不太常用
                
                ```sql
                SELECT field1, field2 FROM table1 ORDER BY field1 COLLATE utf8mb4_unicode_ci;
                ```
        4. 虽然有这个设置，但是在设计的时候应尽量避免让系统严重依赖中文字段的排序结果
2. 查看建数据库的语句`show create database dbNameA;`
    
## 3 表
使用：
1. 查看建表语句`show create table`

## 4 数据类型
MySQL 中，所有的数据类型，都可以显式或隐式的拥有默认值。我们可以使用`DEFAULT`约束显式的为列指定一个默认值。

### 布尔型
### 字符型
MySQL 支持两类字符型数据：文本字符串和二进制字符串

#### 文本字符串
1. `char(n)`:定长字符串，n表示字符数，不是字节数。实际数据不足定义长度时，以**空格补齐**，但在retrieval时，会自动去掉空格。
1. `varchar(num)`：变长字符串
    
    ```sql
    -- 目前mysql没有uuid类型，可以用varchar(36)来存放UUID
    select uuid();
    ```
2. `text`：存储长文本数据，插入时MySQL不会对它进行填充，并且select时不会删除任何末尾的字节。具体类型有四种，区别是可存储的最大长度不同。
    1. 类型
        1. TINYTEXT
        2. TEXT
        3. MEDIUMTEXT
        4. LONGTEXT
    2. 作为索引时：
        1. 当text作为索引的时候，必须 制定索引的长度，而当varchar充当索引的时候，可以不用指明。
        1. 如果text列被作为索引，则在它的内容后面添加空格时，会出现duplicate key错误，也就是说，如果我们定义了一个作为索引的text字段，它的值是'a',则不能定义一个值为'a '的记录，因为这样会产生冲突。
    3. 和`varchar`的区别：
        1. 当text作为索引的时候，必须 制定索引的长度，而当varchar充当索引的时候，可以不用指明。
        2. text列不允许拥有默认值:否则报错"BLOB/TEXT column 'xxx' can't have a default value query"
            1. 允许默认值方法一：修改为非严格模式
                
                ```sql
                -- 方法一：直接修改
                show variables like '%sql_mode%' -- 查看SQL mode
                set global sql_mode='xxx'; -- 去掉SQL mode里的STRICT_TRANS_TABLES再重新设置
                
                -- 方法二：修改my.ini文件
                -- 找到类似下面这样一行，将其注释或去掉其中的 STRICT_TRANS_TABLES,重启服务
                -- sql-mode="..."
                ```
            2. mysql8开始，可以使用表达式代替字面量
                
                ```sql
                CREATE TABLE t2 (b BLOB DEFAULT ('abc')); -- correct，('abc') 是表达式
                CREATE TABLE t2 (b BLOB DEFAULT 'abc'); -- incorrect，'abc' 是字面量，不是表达式
                ```
        3. 存储方式不同：`varchar`/`char`的数据存储在表数据文件中，而`text`是溢出存储,innodb默认只会存放前768字节在数据页中,而剩余的数据则会存储在溢出段中，当text列的内容很多的时候，text列的内容会保留一个指针在记录中，这个指针指向了磁盘中的一块区域，当对这个表进行select *的时候，会从磁盘中读取text的值，影响查询的性能，而varchar不会存在这个问题。
    

#### 二进制字符串
BINARY和VARBIANRY类型同CHAR和VARCHAR类型相似，除了BIANARY和VARBINARY类型只包含二进制字符串。

二进制字符串和普通字符串的区别有两个：
1. 二进制字符串完全可以存储字节零值，以及其他“不可打印”的字节(定义在32到126范围之外的字节)。普通字符串不允许存储字节零值．并且也不允许存储那些不符合选定的字符集编码的非法字节值或字节序列
2. 对二进制字符串的处理实际上就是处理字节，而对字符串的处理，则取决于区域设置。简单地说，二进制字符串适用于存储那些程序员认为是“原始字节”的数据，比如图片内容，而字符串则适合存储文本。

1. `binary(num)`：固定长度二进制字符串,不足最大长度的，将在它们右边填充`\0`(`0x00`)补齐，在retrieval时，不会自动去掉填充的部分(区别于`char(n)`的检出)。
    
    ```sql
    -- binary(36)可以用来存放UUID
    
    -- 例子1
    CREATE TABLE t1 (
         a CHAR(10) CHARACTER SET utf8 COLLATE utf8_bin,
         b BINARY(10)
    );
    INSERT INTO t1 VALUES ('x','x');
    INSERT INTO t1 VALUES ('x ','x ');
    SELECT a, b, HEX(a), HEX(b) FROM t1;
    +------+------------+--------+----------------------+
    | a    | b          | HEX(a) | HEX(b)               |
    +------+------------+--------+----------------------+
    | x    | x          | 78     | 78000000000000000000 |
    | x    | x          | 78     | 78200000000000000000 |
    +------+------------+--------+----------------------+
    ```
2. `VARBINARY(num)`：可变长度二进制字符串
3. `BLOB` 是一个二进制的大对象，用来存储可变数量的数据。BLOB类型有4种，区别是可容纳的c存储范围不同:
    1. TINYBLOB
    2. BLOB
    3. MEDIUMBLOB
    4. LONGBLOB

### 数值型
MySQL支持所有标准SQL数值数据类型。

这些类型包括严格数值数据类型(INTEGER、SMALLINT、DECIMAL和NUMERIC)，以及近似数值数据类型(FLOAT、REAL和DOUBLE PRECISION)。关键字INT是INTEGER的同义词，关键字DEC是DECIMAL的同义词。作为SQL标准的扩展，MySQL也支持整数类型TINYINT、MEDIUMINT和BIGINT。

1. int：4字节，大整形
2. bigint：8字节，极大整形
3. float：4字节，单精度浮点型
4. double：8字节，双精度浮点型

### 日期和时间
有DATETIME、DATE、TIMESTAMP、TIME和YEAR。每个时间类型有一个有效值范围和一个"零"值，当指定不合法的MySQL不能表示的值时使用"零"值。TIMESTAMP类型有专有的自动更新特性。

1. `DATE`:格式`YYYY-MM-DD`
2. `TIME`:格式`HH:MM:SS`
3. `YEAR`:格式`YYYY`
4. `DATETIME`:格式`YYYY-MM-DD HH:MM:SS`
5. `TIMESTAMP`:格式`YYYYMMDD HHMMSS`，混合日期和时间值，时间戳


## 7 查询
### 7.4 where条件
#### 7.4.2 like
参考;https://dev.mysql.com/doc/refman/5.7/en/string-comparison-functions.html#operator_like

like:
1. 是否区分大小写由`COLLATE`决定。
2. 是否忽略尾部的空格由`COLLATE`的`pad attribute`决定，它有两个值：`PAD SPACE`和`NO PAD`，绝大多数`COLLATE`都是`PAD SPACE`(通过`SELECT COLLATION_NAME, PAD_ATTRIBUTE FROM INFORMATION_SCHEMA.COLLATIONS`查看)
    1. `PAD SPACE`:在比较时，尾部的空格会被忽略掉
    2. `NO PAD`: 不会忽略掉尾部的空格，对它而言尾部的空格是重要的。
3. 支持标准sql的两个通配符：
    1. `_`：匹配单个字符
    2. `%`:匹配任意个(包括0个)字符
4. 带ESCAPE使用`LIKE 'xxx' ESCAPE 'oneCharacterA'`:因为默认的转义字符是`\`，所以`oneCharacterA`默认是`\`(转义字符的作用是，让紧跟转义字符的字符变成普通字符处理)，oneCharacterA可以是任意单个字符。
5. As an extension to standard SQL, MySQL permits LIKE on numeric expressions.返回0或1
    
    ```sql
    SELECT 10 LIKE '1%';  -- 1
    SELECT 10 LIKE '2%';  -- 0
    ```

```sql
-- msyql5.x
select 'a' = 'a ', 'a' like 'a '; -- 1 0 

-- mysql8
select 'a' = 'a ', 'a' like 'a '; -- 0 0 
```

### 7.6 order by
mysql的两种排序算法：双路排序和单路排序(todo)

```sql
-- 值为null的字段的排序：升序的时候，null默认被放在最前，降序的时候，null默认被放在最后
-- 1. ORDER BY IF(ISNULL(update_date),0,1) null被强制放在最前，ORDER BY IF(ISNULL(update_date),1,0) null被强制放在最后
```

### 7.7 规定要返回的记录的数目
使用`LIMIT`（待补充）

# 四 高级
## 1 mysql命令行
使用：
1. 登录：`mysql -u userNameA -p passwordA`或`mysql -uuserNameA -ppasswordA`
2. 查看所有数据库`show databases;`
3. 进入数据库`use dbnameA;`
4. 查看所有表`show tables;`
5. 查看表定义`desc tableA`
5. 查看编码`show variables like 'character_set_%';`
6. 按行垂直显示结果`...\G`，也可以在登录的时候设置，带上`-E`，如`mysql -u xxx -E`
    
    ```sql
    select * from user\G
    ```
7. 使用`pager`或者`\P`设置显示方式
    
    ```bash
    # pager more 或者 \P more
    PAGER set to 'more'
    
    # pager less 或者 \P less
    PAGER set to 'less'
    
    # nopager
    PAGER set to stdout
    ```
8. 使用`tee fileA`或`\T fileA`保存运行结果到文件,类似于sqlplus的spool功能，可以将命令行中的结果保存到外部文件中。如果指定已经存在的文件，则结果会附加到文件中。使用`notee`或者`\t`关闭它
9. 执行shell命令`system cmdA`或者`\! cmdA`
    
    ```sql
    system uname
    \! uname
    ```
10. 执行SQL文件`source xxx.sql`或者`\. xxx.sql`
11. SQL预编译

    ```sql
    PREPARE stmt1 FROM 'SELECT SQRT(POW(?,2) + POW(?,2)) AS hypotenuse';
    Query OK, 0 rows affected (0.00 sec)
    Statement prepared

    SET @a = 3;
    Query OK, 0 rows affected (0.00 sec)

    SET @b = 4;                                                   
    Query OK, 0 rows affected (0.00 sec)

    EXECUTE stmt1 USING @a, @b;
    +------------+
    | hypotenuse |
    +------------+
    |          5 |
    +------------+
    1 row in set (0.01 sec)

    DEALLOCATE PREPARE stmt1;                                     
    Query OK, 0 rows affected (0.00 sec)
    ```

## 2 mysql图形界面工具
1. MySQL GUI Tools
由mysql官方提供的早期的图形界面工具，现在下载界面可以看到“Please note that development of MySQL GUI Tools has been discontinued. ”，而是推荐使用MySQL Workbench
2. MySQL Workbench
是下一代的可视化数据库设计、管理的工具，它同时有开源和商业化的两个版本，支持多系统。前身是FabForce公司的DBDesigner4。
3. navicat
用得应该是最多的
4. sequel pro
支持mac平台，是由Cocoa和面对对象的C（Mac OSX）编写的，看到有些大牛在用
4. SQLyog
5. mysqlcc

# 五 经验
1. 今天在命令行里创建表，字段名和表名我都没加``，结果一直最后一行报错，然后我加上它就好了。以前好像不用加的，难道我记错了？
2. workbench左下角显示[not connection]()，原因在于没有启动数据库服务

# 六 问题
## 1 use dbNameA 进入数据库时出现信息：Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A
原因是mysql进入数据库会预读数据库信息，数据库太大会导致进入时很慢，所以提示说的是在登录数据库的时候加上参数`-A`

## 2 ERROR 2059 (HY000): Authentication plugin 'caching_sha2_password' cannot be loaded; 
方法一(待验证)：
1. 增加配置`default_authentication_plugin = mysql_native_password`
2. `alter user 'root'@'localhost' identified with mysql_native_password by 'xxx';`

## 3 忘记密码的找回(待验证)
1. 关闭服务
2. 进入目录 cd /usr/local/mysql/bin/ ，输入 sudo su ，回车后输入 ./mysqld_safe --skip-grant-tables & （别忘了末尾 &）
3.  输入  ./mysql ，进入mysql后输入  mysql> flush privileges ;
4.  回车后输入  mysql> set password for 'root'@'localhost'='newPassA'
5. done

## 4 登录时出现 Access denied for user ‘root‘@‘localhost‘ (using password: YES)
原因一：需要密码但是root用户未设置密码
似乎只能设置密码再访问

# 七 未整理
1. 我的mac上安装的mysql没有类似my.default的配置文件，网上说的要自己在etc目录下新建一个my.cnf
2. mysql的自动补全需要在配置文件中设置一下，由于我的mac中没找到配置文件，暂时不折腾
3. mysql连接数的极限是多少：300到700(300是机械硬盘的理想情况，实际可能200就gg)
